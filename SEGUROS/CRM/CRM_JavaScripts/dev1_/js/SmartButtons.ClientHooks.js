"use strict";var SmartButtons,__awaiter=this&&this.__awaiter||function(t,a,s,u){return new(s=s||Promise)(function(r,e){function n(t){try{i(u.next(t))}catch(t){e(t)}}function o(t){try{i(u.throw(t))}catch(t){e(t)}}function i(t){var e;t.done?r(t.value):((e=t.value)instanceof s?e:new s(function(t){t(e)})).then(n,o)}i((u=u.apply(t,a||[])).next())})},__generator=this&&this.__generator||function(r,n){var o,i,a,t,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return t={next:e(0),throw:e(1),return:e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,i&&(a=2&e[0]?i.return:e[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,e[1])).done)return a;switch(i=0,a&&(e=[2&e[0],a.value]),e[0]){case 0:case 1:a=e;break;case 4:return s.label++,{value:e[1],done:!1};case 5:s.label++,i=e[1],e=[0];continue;case 7:e=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===e[0]||2===e[0])){s=0;continue}if(3===e[0]&&(!a||e[1]>a[0]&&e[1]<a[3])){s.label=e[1];break}if(6===e[0]&&s.label<a[1]){s.label=a[1],a=e;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(e);break}a[2]&&s.ops.pop(),s.trys.pop();continue}e=n.call(r,s)}catch(t){e=[6,t],i=0}finally{o=a=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}};!function(t){var e,r;function n(){var t=Xrm.Utility.getGlobalContext(),e=t.getClientUrl(),r=t.getVersion().toString().split(".");return e+"/api/data/v"+r[0]+"."+r[1]}e=t.ClientHooks||(t.ClientHooks={}),(r=e.SmartButtons||(e.SmartButtons={})).normaliseGuid=function(t){return t.replace("{","").replace("}","")},r.sleepTimeout=function(e){return new Promise(function(t){return setTimeout(t,e)})},r.getWebApiUrl=n,r.request=function(t,e,i,a,s){return"/"===e.charAt(0)&&(e=n()+e),new Promise(function(r,n){var o=new XMLHttpRequest;o.open(t,e,!0),o.setRequestHeader("OData-MaxVersion","4.0"),o.setRequestHeader("OData-Version","4.0"),o.setRequestHeader("Accept","application/json"),o.setRequestHeader("Content-Type","application/json; charset=utf-8"),s&&o.setRequestHeader("Prefer","odata.maxpagesize="+s),a&&o.setRequestHeader("Prefer","odata.include-annotations=OData.Community.Display.V1.FormattedValue"),o.onreadystatechange=function(t){if(4===this.readyState)switch(o.onreadystatechange=null,this.status){case 200:case 202:case 204:r(this);break;default:var e=void 0;try{e=JSON.parse(this.response).error}catch(t){e=new Error("Unexpected Error")}n(e)}},o.send(JSON.stringify(i))})}}(SmartButtons=SmartButtons||{}),function(t){var a,s;a=t.ClientHooks||(t.ClientHooks={}),(s=a.SmartButtons||(a.SmartButtons={})).QuickJavascript=function(t,e,r,n){try{var o=JSON.stringify(t),i=e.replace("%ids%",o);Function("ids","context","commandProperties",i)(t,r,n)}catch(t){Xrm.Navigation.openAlertDialog({text:s.stringFormat(a.ResourceStrings.JSException,t)})}}}(SmartButtons=SmartButtons||{}),function(t){var e,r;e=t.ClientHooks||(t.ClientHooks={}),(r=e.ResourceStrings||(e.ResourceStrings={})).ConfirmWorkflow="Are you sure you want to run the workflow",r.ConfirmWorkflowMultiple="Are you sure you want to run the workflow on {0} record(s)?",r.JSException="Error: '{0}'\nPlease contact your system Administrator",r.WorkflowNotPublished="Workflow '{0}' is not published",r.RunWorkflowConfigMessage="The RunWorkflow button now requires two additional parameters: RrrorCallback and PrimaryControl",r.FlowEnvironmentVariableNotFound="The envrionment value '{0}' cannot be found",r.RunningWorkflow="Running workflow '{0}'. Please wait...",r.RecordProgressCount="{0} of {1}",r.RunningFlow="Please wait..."}(SmartButtons=SmartButtons||{}),function(t){var e,c;e=t.ClientHooks||(t.ClientHooks={}),(c=e.SmartButtons||(e.SmartButtons={})).RunReport=function(a,s,u){return __awaiter(this,void 0,void 0,function(){var e,r,n,o,i;return __generator(this,function(t){switch(t.label){case 0:return e="<fetch count='1'>\n        <entity name='report'>\n            <attribute name='reportid'/>\n            <filter type='and'>\n                <condition attribute='name' operator='eq' value='"+a+"'/>\n            </filter>\n        </entity>\n        </fetch>",[4,Xrm.WebApi.retrieveMultipleRecords("report","?fetchXml="+e)];case 1:return(r=t.sent())&&0<r.entities.length&&(n=encodeURIComponent(c.normaliseGuid(r.entities[0].reportid)),o=Xrm.Utility.getGlobalContext().getClientUrl(),i=o+"/crmreports/viewer/viewer.aspx?action=run&id=%7b"+n+"%7d&records=%7b"+c.normaliseGuid(s)+"%7d&context=records&recordstype="+u,Xrm.Navigation.openUrl(i)),[2]}})})}}(SmartButtons=SmartButtons||{}),function(t){var w,v,d;function b(r,n,t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return e={id:v.normaliseGuid(n)},[4,v.request("POST",r,e)];case 1:return t.sent(),[2]}})})}w=t.ClientHooks||(t.ClientHooks={}),v=w.SmartButtons||(w.SmartButtons={}),d="smartbutton.flowWait",v.RunWebHook=b,v.RunWebHookSingle=function(u,c,l,f,m,g){return __awaiter(this,void 0,void 0,function(){var e,r,n,o,i,a,s;return __generator(this,function(t){switch(t.label){case 0:return g||Xrm.Navigation.openAlertDialog({text:w.ResourceStrings.RunWorkflowConfigMessage}),""==m&&(m=void 0),e=!0,l?(r=v.stringFormat(l,c.length),[4,Xrm.Navigation.openConfirmDialog({title:"",text:r})]):[3,2];case 1:n=t.sent(),e=n&&n.confirmed,t.label=2;case 2:return e?[4,g.data.entity.save()]:[3,12];case 3:t.sent(),t.label=4;case 4:t.trys.push([4,9,,10]),g.ui.setFormNotification(v.stringFormat(w.ResourceStrings.RunningFlow,name),"INFO",d),o=0,i=c,t.label=5;case 5:return o<i.length?(a=i[o],[4,b(u,a)]):[3,8];case 6:t.sent(),t.label=7;case 7:return o++,[3,5];case 8:return g.ui.clearFormNotification(d),f&&Function(f)(),[3,10];case 9:return s=t.sent(),m?Function("ex",m)(s.message):g?g.ui.setFormNotification(s.message,"ERROR","RibbonWorkflowError"):Xrm.Navigation.openAlertDialog({text:s.message}),[3,10];case 10:return g.ui.clearFormNotification(d),[4,g.data.refresh(!1)];case 11:t.sent(),t.label=12;case 12:return[2]}})})},v.RunWebHookMultiple=function(l,f,m,g,d,p,h){return __awaiter(this,void 0,void 0,function(){var e,r,n,o,i,a,s,u,c;return __generator(this,function(t){switch(t.label){case 0:return p||Xrm.Navigation.openAlertDialog({text:w.ResourceStrings.RunWorkflowConfigMessage}),""==d&&(d=void 0),e=!0,m?(r=v.stringFormat(m,f.length),[4,Xrm.Navigation.openConfirmDialog({title:"",text:r})]):[3,2];case 1:n=t.sent(),e=n&&n.confirmed,t.label=2;case 2:if(!e)return[3,9];o=1,i=f.length,t.label=3;case 3:t.trys.push([3,8,,9]),a=0,s=f,t.label=4;case 4:return a<s.length?(u=s[a],Xrm.Utility.showProgressIndicator(v.stringFormat(w.ResourceStrings.RunningFlow,name)+v.stringFormat(w.ResourceStrings.RecordProgressCount,o,i)),[4,b(l,u)]):[3,7];case 5:t.sent(),o++,t.label=6;case 6:return a++,[3,4];case 7:Xrm.Utility.closeProgressIndicator(),g&&Function(g)();try{h.refresh()}catch(t){}return[3,9];case 8:return c=t.sent(),Xrm.Utility.closeProgressIndicator(),d?Function("ex",d)(c.message):Xrm.Navigation.openAlertDialog({text:c.message}),[3,9];case 9:return[2]}})})}}(SmartButtons=SmartButtons||{}),function(t){var w,v,d;function p(t,o,e,i){return __awaiter(this,void 0,void 0,function(){var e,r,n;return __generator(this,function(t){switch(t.label){case 0:i=i||new Date,e=!1,t.label=1;case 1:return e?[3,7]:[4,Xrm.WebApi.retrieveRecord("asyncoperation",o,"?$select=statecode,statuscode")];case 2:return r=t.sent(),(n=r.statuscode)&&30==n?(e=!0,[3,6]):[3,3];case 3:if(!(n&&31<=n||18e4<((new Date).getTime()-i.getTime())/1e3))return[3,4];throw"Exception during running workflow";case 4:return[4,v.sleepTimeout(1e3)];case 5:t.sent(),t.label=6;case 6:return[3,1];case 7:return[2]}})})}function b(m,g,t){return __awaiter(this,void 0,void 0,function(){var r,n,o,i,a,s,u,c,l,f;return __generator(this,function(t){switch(t.label){case 0:return r="<fetch count='1'>\n                    <entity name='workflow'>\n                        <attribute name='workflowid'/>\n                        <filter type='and'>\n                            <condition attribute='name' operator='eq' value='"+m+"'/>\n                            <condition attribute='ondemand' operator='eq' value='true'/>\n                            <condition attribute='statuscode' operator='eq' value='2'/>\n                            <condition attribute='type' operator='eq' value='1'/>\n                        </filter>\n                    </entity>\n                    </fetch>",[4,Xrm.WebApi.retrieveMultipleRecords("workflow","?fetchXml="+r)];case 1:if(0==(n=t.sent()).entities.length)throw o=v.stringFormat(w.ResourceStrings.WorkflowNotPublished,m),new Error(o);i=0,a=n.entities,t.label=2;case 2:return i<a.length?(s=a[i],u=s.workflowid,e.prototype.getMetadata=function(){return{boundParameter:"entity",parameterTypes:{entity:{typeName:"Microsoft.Dynamics.CRM.workflow",structuralProperty:5},EntityId:{typeName:"Edm.Guid",structuralProperty:1}},operationType:0,operationName:"ExecuteWorkflow"}},c=new e,[4,Xrm.WebApi.online.execute(c)]):[3,8];case 3:return[4,t.sent().text()];case 4:return""!=(l=t.sent())?[3,5]:[2];case 5:return f=JSON.parse(l),[4,p(0,f.asyncoperationid)];case 6:t.sent(),t.label=7;case 7:return i++,[3,2];case 8:return[2]}function e(){this.EntityId={guid:v.normaliseGuid(g)},this.entity={id:u,entityType:"workflow"}}})})}w=t.ClientHooks||(t.ClientHooks={}),v=w.SmartButtons||(w.SmartButtons={}),d="smartbutton.workflowWait",v.WaitForWorkflowToComplete=p,v.RunWorkflow=b,v.RunWorkflowSingle=function(u,c,l,f,m,g){return __awaiter(this,void 0,void 0,function(){var e,r,n,o,i,a,s;return __generator(this,function(t){switch(t.label){case 0:return g||Xrm.Navigation.openAlertDialog({text:w.ResourceStrings.RunWorkflowConfigMessage}),""==m&&(m=void 0),e=!0,l?(r=v.stringFormat(l,c.length),[4,Xrm.Navigation.openConfirmDialog({title:"",text:r})]):[3,2];case 1:n=t.sent(),e=n&&n.confirmed,t.label=2;case 2:return e?[4,g.data.entity.save()]:[3,12];case 3:t.sent(),t.label=4;case 4:t.trys.push([4,9,,10]),g.ui.setFormNotification(v.stringFormat(w.ResourceStrings.RunningWorkflow,u),"INFO",d),o=0,i=c,t.label=5;case 5:return o<i.length?(a=i[o],[4,b(u,a)]):[3,8];case 6:t.sent(),t.label=7;case 7:return o++,[3,5];case 8:return g.ui.clearFormNotification(d),f&&Function(f)(),[3,10];case 9:return s=t.sent(),m?Function("ex",m)(s):g?g.ui.setFormNotification(s,"ERROR","RibbonWorkflowError"):Xrm.Navigation.openAlertDialog({text:s.toString()}),[3,10];case 10:return g.ui.clearFormNotification(d),[4,g.data.refresh(!1)];case 11:t.sent(),t.label=12;case 12:return[2]}})})},v.RunWorkflowMultiple=function(l,f,m,g,d,p,h){return __awaiter(this,void 0,void 0,function(){var e,r,n,o,i,a,s,u,c;return __generator(this,function(t){switch(t.label){case 0:return p||Xrm.Navigation.openAlertDialog({text:w.ResourceStrings.RunWorkflowConfigMessage}),""==d&&(d=void 0),e=!0,m?(r=v.stringFormat(m,f.length),[4,Xrm.Navigation.openConfirmDialog({title:"",text:r})]):[3,2];case 1:n=t.sent(),e=n&&n.confirmed,t.label=2;case 2:if(!e)return[3,9];o=1,i=f.length,t.label=3;case 3:t.trys.push([3,8,,9]),a=0,s=f,t.label=4;case 4:return a<s.length?(u=s[a],Xrm.Utility.showProgressIndicator(v.stringFormat(w.ResourceStrings.RunningWorkflow,l)+v.stringFormat(w.ResourceStrings.RecordProgressCount,o,i)),[4,b(l,u)]):[3,7];case 5:t.sent(),o++,t.label=6;case 6:return a++,[3,4];case 7:Xrm.Utility.closeProgressIndicator(),g&&Function(g)();try{h.refresh()}catch(t){}return[3,9];case 8:return c=t.sent(),Xrm.Utility.closeProgressIndicator(),d?Function("ex",d)(c):Xrm.Navigation.openAlertDialog({text:c.toString()}),[3,9];case 9:return[2]}})})}}(SmartButtons=SmartButtons||{}),function(t){var e;((e=t.ClientHooks||(t.ClientHooks={})).SmartButtons||(e.SmartButtons={})).stringFormat=function(t){for(var r=[],e=1;e<arguments.length;e++)r[e-1]=arguments[e];return t.replace(/{(\d+)}/g,function(t,e){return void 0!==r[e]?r[e]:t})}}(SmartButtons=SmartButtons||{});